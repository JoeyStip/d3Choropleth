<!DOCTYPE html>
<html>
    <head>
        <link href='index.css' rel='stylesheet'>
        <link rel='shortcut icon' href='https://cdn-icons-png.flaticon.com/512/49/49688.png'>
        <title>Choropleth Chart</title>
    </head>
    <body>
        <script src='https://unpkg.com/topojson-client@3'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js'></script>
        <script type='module'>
            import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

            const educationURL = 'https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json'
            const countyURL = 'https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json'

            let countyData;
            let educationData;
            const [color1, color2, color3, color4, color5] = [['#231942', 15], ['#5e548e', 30], ['#9f86c0', 45], ['#be95c4', 60], ['#e0b1cb', 75]];

            const container = d3
                .select("body")
                .append("div")
                .attr("id", "container");
    
            const titleAndDescription = container
                .append("div")
                .attr("id", "titleAndSubtitle");
                
            const title = titleAndDescription
                .append("h1")
                .attr("id", "title")
                .html("Education Attainment");

            const description = titleAndDescription
                .append("h2")
                .attr("id", "description")
                .html("Concentration of Bachelors attainment in the US by county");
            
            const svg = d3
                .select('#container')
                .append('svg')
                .attr('width', 1000)
                .attr('height', 800);
            
            const legend = svg
                .append("g")
                .attr("id", "legend")

            const legendScale = d3
                .scaleBand()
                .domain([])

            const canvas = svg
                .append("g")
                .attr("id", "canvas");
                
            const drawMap =()=> {
                canvas.selectAll('path')
                    .data(countyData)
                    .enter()
                    .append('path')
                    .attr('d', d3.geoPath())
                    .attr('class', 'county')
                    .attr('fill', (countyDataItem)=>{
                        let id = countyDataItem['id'];
                        let county = educationData.find((item)=> {
                            return item['fips'] === id;
                        });
                        let percentage = county['bachelorsOrHigher'];
                        if(percentage <= color1[1]){
                            return color1[0];
                        }else if(percentage <= color2[1]){
                            return color2[0];
                        }else if(percentage <= color2[1]){
                            return color3[0];
                        }else if(percentage <= color3[1]){
                            return color4[0];
                        }else{
                            return color5[0];
                        }
                    })
                    .attr("data-fips", (countyDataItem)=>countyDataItem.id)
                    .attr("data-education", (countyDataItem)=>{
                        let id = countyDataItem.id;
                        let county = educationData.find((item)=>{
                            return item.fips === id;
                        });
                        return county.bachelorsOrHigher;
                    })
            };

            d3.json(countyURL).then(
                (data, error) => {
                    if(error){
                        console.log(log)
                    }else{
                        countyData = topojson.feature(data, data.objects.counties).features;
                        console.log('countyData:', countyData)

                        d3.json(educationURL).then(
                            (data, error) => {
                                if(error){
                                    console.log(error);
                                }else{
                                    educationData = data;
                                    console.log('educationData: ', educationData);
                                    drawMap();
                                };
                            }
                        );
                    };
                }
            );
        </script>
        <script src='https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js'></script>
    </body>
</html>