<!DOCTYPE html>
<html>
    <head>
        <link href='index.css' rel='stylesheet'>
        <link rel='shortcut icon' href='https://cdn-icons-png.flaticon.com/512/49/49688.png'>
        <title>Choropleth Chart</title>
    </head>
    <body>
        <script src='https://unpkg.com/topojson-client@3'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js'></script>
        <script type='module'>
            import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

            const educationURL = 'https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json'
            const countyURL = 'https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json'

            let countyData;
            let educationData;
            const colors = [
                {code:'#231942', limit: 15}, 
                {code:'#5e548e', limit: 30}, 
                {code:'#9f86c0', limit: 45}, 
                {code: '#be95c4', limit: 60}, 
                {code:'#e0b1cb', limit: 75}
            ];
            const margin = {
                left: 50,
                right: 50,
                bottom: 50,
                top: 80
            };

            const w = 1200 - margin.left - margin.right;
            const h = 800 - margin.top - margin.bottom;

            const container = d3
                .select("body")
                .append("div")
                .attr("id", "container");
    
            const titleAndDescription = container
                .append("div")
                .attr("id", "titleAndSubtitle");
                
            const title = titleAndDescription
                .append("h1")
                .attr("id", "title")
                .html("Education Attainment");

            const description = titleAndDescription
                .append("h2")
                .attr("id", "description")
                .html("Concentration of Bachelors attainment in the US by county");
            
            const svg = d3
                .select('#container')
                .append('svg')
                .attr('width', w)
                .attr('height', h)
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            const drawLegend =()=> {
                const legendW = 300;
                const legendH = 15;
                const bachelorsOrHigher = educationData.map((x)=>x.bachelorsOrHigher);
                const minBachelors = Math.min(...bachelorsOrHigher);
                const maxBachelors = Math.max(...bachelorsOrHigher);

                const legendThresholdScale = d3
                    .scaleThreshold()
                    .domain(colors.map((x)=>x.limit))
                    .range(colors.map((x)=>x.code));

                const legendXScale = d3
                    .scaleLinear()
                    .domain([minBachelors, maxBachelors])
                    .range([0, legendW]);

                const legendAxis = d3
                    .axisBottom()
                    .scale(legendXScale)
                    .tickSize(10, 0)
                    .tickValues(legendThresholdScale.domain());

                const legend = svg
                    .append("g")
                    .attr("id", "legend")
                    .attr("transform", "translate(" + (w*.66) + ",15)")
                
                legend
                    .append('g')
                    .call(legendAxis);

                const squares = legend
                    .append("g")
                    .selectAll("rect")
                    .data(
                        legendThresholdScale.range().map((color)=>{
                            let d = legendThresholdScale.invertExtent(color);
                            if(d[0]===undefined){
                                d[0]=legendXScale.domain()[0];
                            };
                            if(d[1]===undefined){
                                d[1]=legendXScale.domain()[1];
                            };
                                return d;
                            })
                    )
                    .enter()
                    .append("rect")
                    .style("fill", (d)=>{
                        return legendThresholdScale(d[0]);
                    })
                    .attr("x", (d)=>legendXScale(d[0]))
                    .attr("y", 0-legendH)
                    .attr("width", (d)=>{
                        return d[0] && d[1] ? legendXScale(d[1])-legendXScale(d[0]) : legendXScale(null)
                    })
                    .attr("height", legendH);
            };

            const canvas = svg
                .append("g")
                .attr("id", "canvas");
                
            const drawMap =()=> {
                canvas.selectAll('path')
                    .data(countyData)
                    .enter()
                    .append('path')
                    .attr('d', d3.geoPath())
                    .attr('class', 'county')
                    .attr('fill', (countyDataItem)=>{
                        let id = countyDataItem['id'];
                        let county = educationData.find((item)=> {
                            return item['fips'] === id;
                        });
                        let percentage = county['bachelorsOrHigher'];
                        if(percentage <= colors[0].limit){
                            return colors[0].code;
                        }else if(percentage <= colors[1].limit){
                            return colors[1].code;
                        }else if(percentage <= colors[2].limit){
                            return colors[2].code;
                        }else if(percentage <= colors[3].limit){
                            return colors[3].code;
                        }else{
                            return colors[4].code;
                        }
                    })
                    .attr("data-fips", (countyDataItem)=>countyDataItem.id)
                    .attr("data-education", (countyDataItem)=>{
                        let id = countyDataItem.id;
                        let county = educationData.find((item)=>{
                            return item.fips === id;
                        });
                        return county.bachelorsOrHigher;
                    })
            };

            d3.json(countyURL).then(
                (data, error) => {
                    if(error){
                        console.log(log)
                    }else{
                        countyData = topojson.feature(data, data.objects.counties).features;
                        console.log('countyData:', countyData)

                        d3.json(educationURL).then(
                            (data, error) => {
                                if(error){
                                    console.log(error);
                                }else{
                                    educationData = data;
                                    console.log('educationData: ', educationData);
                                    drawMap();
                                    drawLegend();
                                };
                            }
                        );
                    };
                }
            );
        </script>
        <script src='https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js'></script>
    </body>
</html>